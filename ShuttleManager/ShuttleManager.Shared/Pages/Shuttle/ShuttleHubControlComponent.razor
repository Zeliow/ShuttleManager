@using System.Diagnostics
@using ShuttleManager.Shared.Services
@using ShuttleManager.Shared.Services.FilePicker
@using ShuttleManager.Shared.Services.OtaUpdate
@using ShuttleManager.Shared.Services.ShuttleClient
@using ShuttleManager.Shared.Services.WebBrowser
@using System.Text.Json.Nodes
@using ShuttleManager.Shared.Models
@using ShuttleManager.Shared.Models.Protocol
@using Microsoft.Extensions.Logging
@inject IJSRuntime JSRuntime
@inject IShuttleHubClientService HubClientService
@inject ILogger<ShuttleHubControlComponent> Logger
@inject IWebBrowserService WebBrowserService
@inject IFilePickerService FilePickerService
@inject IOtaUpdateService OtaService
@implements IDisposable

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            –®–∞—Ç—Ç–ª ‚Ññ: @SeeCorrentNumberShuttle(Shuttle.ShuttleNumber)
            <span class="badge @(IsConnected ? "bg-success" : "bg-warning") ms-2">
                @(IsConnected ? "–ü–æ–¥–∫–ª—é—á–µ–Ω" : "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...")
            </span>
        </h5>
        <div>
            <button class="btn btn-sm btn-danger" @onclick="DisconnectThis" title="–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è">
                <i class="bi bi-power"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (!IsConnected)
        {
            <div class="alert alert-warning mb-3 d-flex align-items-center">
                <i class="bi bi-hourglass-split me-2"></i>
                <div>
                    <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ @Shuttle.IPAddress...</strong>
                    @if (_connectionAttempts > 0)
                    {
                        <div class="small">–ü–æ–ø—ã—Ç–∫–∞ @_connectionAttempts</div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">–ë–∞—Ç–∞—Ä–µ—è:</label>
                        <p id="batteryData_@ComponentId" class="fw-bold @GetBatteryColorClass()">
                            @BatteryData
                        </p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">–°—Ç–∞—Ç—É—Å:</label>
                        <p id="currentStatus_@ComponentId" class="fw-bold @GetStatusColorClass()">
                            @CurrentStatus
                        </p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</label>
                        <p class="small text-muted">@LastActivityTime</p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</label>
                        <p class="small text-muted">@Uptime</p>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-7">
                        <div class="card mb-2">
                            <div class="card-body p-2" style="height: 100%">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label>–¢–µ—Ä–º–∏–Ω–∞–ª: </label>
                                    <div style="height: 100%">
                                        <button class="btn btn-sm btn-outline-danger me-1" @onclick="ClearTerminal" title="–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª">
                                            <i class="bi bi-trash">‚ùå</i>
                                        </button>
                                        <span class="badge bg-secondary">@Shuttle.GetTerminalMessages().Count —Å—Ç—Ä–æ–∫</span>
                                    </div>
                                </div>
                                <div id="terminalContainer_@ComponentId"
                                     class="terminal-container border rounded"
                                     style="height: 448px;">
                                    @((MarkupString)TerminalOutputHtml)
                                </div>
                                <div class="input-group input-group-sm mt-2">
                                    <span class="input-group-text">
                                        <i class="bi bi-terminal"></i>
                                    </span>
                                    <InputText @bind-Value="ManualCommand"
                                               class="form-control form-control-sm"
                                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..."
                                               @onkeypress="HandleKeyPress"
                                               disabled="@(!IsConnected || _isCommandInProgress)" />
                                    <button class="btn btn-primary btn-sm"
                                            @onclick="SendManualCommand">
                                        <i class="bi bi-send"></i> –û—Ç–ø—Ä
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div class="row g-1">
                                        <div class="col-6 mb-1">
                                            <button class="btn btn-danger btn-sm w-100" @onclick="SendResetCommand" title="–°–±—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö –æ—à–∏–±–æ–∫">
                                                <i class="bi bi-arrow-counterclockwise me-1"></i>–°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
                                            </button>
                                        </div>
                                        <div class="col-6 mb-1">
                                            <button class="btn btn-secondary btn-sm w-100" @onclick="SendCalibrateCommand" title="–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏">
                                                <i class="bi bi-rulers me-1"></i>–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
                                            </button>
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-danger btn-sm w-100 " @onclick="SendRebootShuttleCommand" title="–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —à–∞—Ç—Ç–ª–∞">
                                                <i class="bi bi-arrow-repeat me-1"></i>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div class="row g-1">
                                        <div class="col-6">
                                            @*  <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="OpenOtaDisplayUpdate" title="OTA Display">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>‚ö†Ô∏èdisplay firmware
                                                </button>
                                            </div> *@
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendUpdateStateShuttleCommand" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞ (UPD) (Browser)
                                                </button>
                                            </div>
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SetTime" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            @*   <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="OpenOtaStmUpdate" title="OTA STM">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>‚ö†Ô∏èSTM firmware
                                                </button>
                                            </div> *@
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendFRMFirmwareCommand" title="–û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—à–∏–≤–∫–∏">
                                                    <i class="bi bi-cloud-arrow-up me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ –ø–ª–∞—Ç—ã (FRM) (Browser)
                                                </button>
                                            </div>
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="OpenLogsShuttle" title="–û—Ç–∫—Ä—ã—Ç—å –ª–æ–≥–∏ —à–∞—Ç—Ç–ª–∞" disabled="@(OperatingSystem.IsAndroid())">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>–õ–æ–≥–∏ —à–∞—Ç—Ç–ª–∞
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">–ö–æ–º–∞–Ω–¥—ã</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendLoadCommand" title="–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏">
                                                    <i class="bi bi-upload me-1"></i>–ó–∞–≥—Ä—É–∑–∫–∞ ‚Üó
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendLargeLoadCommand" title="–ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏">
                                                    <i class="bi bi-upload me-1"></i>–ü. –ó–∞–≥—Ä—É–∑–∫–∞ ‚Üó‚Üó
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendUnloadCommand" title="–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ –≤—ã–≥—Ä—É–∑–∫–∏">
                                                    <i class="bi bi-download me-1"></i>–í—ã–≥—Ä—É–∑–∫–∞ ‚Üò
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendLargeUnloadCommand" title="–ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≤—ã–≥—Ä—É–∑–∫–∏">
                                                    <i class="bi bi-download me-1"></i>–ü. –í—ã–≥—Ä—É–∑–∫–∞ ‚Üò‚Üò
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendSealingForwardShuttleCommand" title="–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥">
                                                    <i class="bi bi-arrows-angle-contract me-1"></i>–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendSealingBackShuttleCommand" title="–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –Ω–∞–∑–∞–¥">
                                                    <i class="bi bi-arrows-angle-expand me-1"></i>–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –Ω–∞–∑–∞–¥
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-info btn-sm w-100 p-2" @onclick="SendDemoCommand" title="–ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞">
                                                    <i class="bi bi-play-circle me-1"></i>–î–µ–º–æ-—Ä–µ–∂–∏–º
                                                </button>
                                            </div>
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendUpShuttleCommand" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥">
                                                    <i class="bi bi-arrow-up-square me-1"></i>‚Üë –≤–≤–µ—Ä—Ö ‚Üë
                                                </button>
                                            </div>
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-warning btn-sm w-100 p-2"
                                                        style="background-color: @(isReversed ? "green" : "red");"
                                                        @onclick="SendReverseShuttleCommand"
                                                        title="–†–µ–≤–µ—Ä—Å">
                                                    <i class="bi bi-download me-1"></i>–†–µ–≤–µ—Ä—Å üîÑ
                                                </button>
                                            </div>

                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendLeftShuttleCommand" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ">
                                                    <i class="bi bi-arrow-left-square me-1"></i>‚Üê –Ω–∞–∑–∞–¥ ‚Üê
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendDownShuttleCommand" title="–î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–∑–∞–¥">
                                                    <i class="bi bi-arrow-down-square me-1"></i>‚Üì –≤–Ω–∏–∑ ‚Üì
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendRightShuttleCommand" title="–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ">
                                                    <i class="bi bi-arrow-right-square me-1"></i>‚Üí –≤–ø–µ—Ä—ë–¥ ‚Üí
                                                </button>
                                            </div>

                                            <div class="col-12 mb-1">
                                                <button class="btn btn-danger btn-sm w-100 p-3" @onclick="SendStopCommand" title="–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π">
                                                    <i class="bi bi-stop-circle-fill me-1"></i><strong>STOP</strong>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="ShuttleNumberInput" class="form-control form-control-sm" min="1" max="999" placeholder="–ù–æ–º–µ—Ä —à–∞—Ç—Ç–ª–∞" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="3" @onclick="SendSetShuttleNumCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä —à–∞—Ç—Ç–ª–∞">
                                                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä —à–∞—Ç—Ç–ª–∞
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MoveDistanceBackwardInput" class="form-control form-control-sm" min="0" max="10000" step="10" placeholder="–†–∞—Å—Å—Ç. –Ω–∞–∑–∞–¥ (–º–º)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetMoveReverseShuttleCommand" title="–ü—Ä–æ–µ–∑–¥ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –Ω–∞–∑–∞–¥">
                                                        –î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–∑–∞–¥, –º–º ‚Æú‚Æú
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MoveDistanceForwardInput" class="form-control form-control-sm" min="0" max="10000" step="10" placeholder="–†–∞—Å—Å—Ç. –≤–ø–µ—Ä—ë–¥ (–º–º)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendMoveForwardShuttleCommand" title="–ü—Ä–æ–µ–∑–¥ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤–ø–µ—Ä—ë–¥">
                                                        –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥, –º–º ‚Æû‚Æû
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MaxSpeedInput" class="form-control form-control-sm" min="5" max="100" step="1" placeholder="–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å (%)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="5" @onclick="SendSetMaxSpeedShuttleCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å">
                                                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å, % V
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MinPowerInput" class="form-control form-control-sm" min="0" max="100" step="1" placeholder="–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å (%)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetMinPowerShuttleCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã –±–∞—Ç–∞—Ä–µ–∏">
                                                        –£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã –±–∞—Ç–∞—Ä–µ–∏, %
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="PallentDistance" class="form-control form-control-sm" min="0" max="500" step="10" placeholder="–º–µ–∂. –ø–∞–ª–ª–µ—Ç. —Ä–∞—Å—Ç–æ—è–Ω–∏–µ (–º–º)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetPalletBetweenDistanceShuttleCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ–∂–ø–∞–ª–ª–µ—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ">
                                                        –ú–µ–∂–ø–∞–ª–ª–µ—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –º–º ‚Üî
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="LenghtOfShuttle" class="form-control form-control-sm" min="800" max="1200" step="200" placeholder="=–î–ª–∏–Ω–∞ —à–∞—Ç—Ç–ª–∞" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="800" @onclick="SendSetlenghtOfShuttleCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–ª–∏–Ω—É —à–∞—Ç—Ç–ª–∞">
                                                        –î–ª–∏–Ω–∞ —à–∞—Ç—Ç–ª–∞, –º–º üìè
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="DistanceOfEdge" class="form-control form-control-sm" min="0" max="500" step="10" placeholder="–†–∞—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫—Ä–∞—è" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetDistanceOfEdgeShuttleCommand" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫—Ä–∞—è">
                                                        –†–∞—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫—Ä–∞—è, –º–º ‚î§
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-1 mt-1">
                                            <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendSaveSettingCommand" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –ø–∞–º—è—Ç—å">
                                                <i class="bi bi-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        @*
                                        <button @onclick="ChoiceFile">Select .bin</button>

                                        @if (_selectedFile != null)
                                        {
                                        <p>@_selectedFile</p>*@

                                        <div class="row g-1">
                                            <div class="col-6 mb-1" style="text-align: center;">
                                                <button class="btn btn-warning btn-sm w-100" disabled="@_isOtaRunning" @onclick="() => StartOta(OtaTarget.Stm32)">
                                                    <i>–û–±–Ω–æ–≤–∏—Ç—å STM</i>
                                                </button>
                                                <label for="Erase">full erase STM: </label>
                                                <input type="checkbox" id="IsArase" name="Erase" checked="@IsFullErased" @onchange="OnAraseModeChanged" />
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" disabled="@_isOtaRunning" @onclick="() => StartOta(OtaTarget.Esp32)">
                                                    <i>–û–±–Ω–æ–≤–∏—Ç—å ESP</i>
                                                </button>
                                            </div>
                                        </div>
                                        @*  } *@

                                        @if (_isOtaRunning)
                                        {
                                            <progress value="@_otaPercent" max="100"></progress>
                                            <p>@_otaPercent %</p>
                                            <button @onclick="CancelOta">–û—Ç–º–µ–Ω–∞</button>
                                        }

                                        <i>@_otaStatus</i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public Shuttle Shuttle { get; set; } = null!;
    [Parameter] public EventCallback<string> OnDisconnected { get; set; }

    private int ShuttleNumberInput = 1;
    private int MoveDistanceBackwardInput = 0;
    private int MoveDistanceForwardInput = 0;
    private int DistanceOfEdge = 0;
    private int LenghtOfShuttle = 800;
    private int MaxSpeedInput = 0;
    private int MinPowerInput = 0;
    private int PallentDistance = 0;
    private string NameOfFirmware = "";
    private bool isAndroid => OperatingSystem.IsAndroid();

    private string _terminalOutputHtml = "";
    private string _manualCommand = "";
    private string _componentId = Guid.NewGuid().ToString();
    private bool _isCommandInProgress;
    private int _connectionAttempts = 0;
    private CancellationTokenSource _componentCts = new();
    private bool IsFullErased = false;

    private string CurrentStatus => Shuttle.CurrentStatus;
    private int ErrorCode => Shuttle.ErrorCode;
    private int WarningCode => Shuttle.WarningCode;
    private double Voltage => Shuttle.BatteryVoltage;
    private int BatteryPercentageValue => Shuttle.BatteryPercentage;
    private string LastActivityTime => Shuttle.LastActivity.ToString("HH:mm:ss");
    private string Uptime => (DateTime.Now - Shuttle.ConnectionTime).ToString(@"hh\:mm\:ss");
    private string BatteryData => $"–ë–∞—Ç–∞—Ä–µ—è: {Shuttle.BatteryVoltage:F1}V | –ó–∞—Ä—è–¥: {Shuttle.BatteryPercentage}%";
    private bool IsConnected => Shuttle.IsConnected;
    private string ComponentId => _componentId;
    private string TerminalOutputHtml => _terminalOutputHtml;
    private string ManualCommand { get => _manualCommand; set => _manualCommand = value; }
    private string pathLogShuttle = "";

    private readonly List<string> _statusBlockLines = new();
    private bool _inStatusBlock = false;

    //Ota Update
    private string? _selectedFile;
    private int _otaPercent;
    private bool _isOtaRunning;
    private string _otaStatus = "";
    private CancellationTokenSource? _otaCts;
    //Ota Update

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!Directory.Exists($"{AppContext.BaseDirectory}/logs"))
            {
                Directory.CreateDirectory($"{AppContext.BaseDirectory}/logs");
            }
            HubClientService.Connected += OnHubConnected;
            HubClientService.Disconnected += OnHubDisconnected;
            HubClientService.LogReceived += OnLogReceived;
            pathLogShuttle = Path.Combine($"{AppContext.BaseDirectory}/logs", $"Shuttle_Log_Number_{DateTime.Now.Day}_{DateTime.Now.Month}_{DateTime.Now.Year}_{Shuttle.IPAddress}.txt");
            Logger.LogInformation("–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è {IpAddress}", Shuttle.IPAddress);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è {IpAddress}", Shuttle.IPAddress);
            LogToTerminal($"[ERROR] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {ex.Message}\n");
        }
    }

    private async Task StartOta(OtaTarget target)
    {
        await ChoiceFile();

        if (_selectedFile == null)
            return;

        _isOtaRunning = true;
        _otaPercent = 0;
        _otaStatus = "Starting OTA...";
        _otaCts = new CancellationTokenSource();

        var progress = new Progress<OtaProgress>(p =>
        {
            _otaPercent = p.Percent;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            var result = await OtaService.RunAsync(
                Shuttle.IPAddress!,
                _selectedFile,
                target,
                progress,
                _otaCts.Token,
                IsFullErased
            );

            _otaStatus = result.IsSuccess ? "OTA Completed" : $"Error: {result.Error}";
        }
        catch (Exception ex)
        {
            _otaStatus = $"Error: {ex.Message}";
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ OTA –¥–ª—è {IpAddress}", Shuttle.IPAddress);
        }
        finally
        {
            _isOtaRunning = false;
            StateHasChanged();
        }
    }

    private void CancelOta()
    {
        _otaCts?.Cancel();
    }

    private string SeeCorrentNumberShuttle(string numberShuttle)
    {
        if (!string.IsNullOrEmpty(numberShuttle) && char.IsDigit(numberShuttle[0]))
        {
            return numberShuttle;
        }
        else if (!string.IsNullOrEmpty(numberShuttle))
        {
            return numberShuttle.Substring(1);
        }
        return numberShuttle;
    }

    private bool IsEventForThisShuttle(string ipAddress)
    {
        return ipAddress == Shuttle.IPAddress;
    }

    private async void OnHubConnected(string ip, int id)
    {
        if (!IsEventForThisShuttle(ip)) return;

        await InvokeAsync(() =>
        {
            Shuttle.IsConnected = true;
            Shuttle.ConnectionTime = DateTime.Now;
            Shuttle.LastActivity = DateTime.Now;
            LogToTerminal($"[SUCCESS] –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —à–∞—Ç—Ç–ª—É ID: {id}\n");
            StateHasChanged();
        });
    }

    private async void OnHubDisconnected(string ip)
    {
        if (!IsEventForThisShuttle(ip)) return;

        await InvokeAsync(() =>
        {
            Shuttle.IsConnected = false;
            LogToTerminal("[WARNING] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ\n");
            StateHasChanged();
            _ = OnDisconnected.InvokeAsync(ip);
        });
    }

    private async void OnLogReceived(string ip, ShuttleMessageBase msg)
    {
        if (!IsEventForThisShuttle(ip)) return;

        var formattedString = msg.ToFormattedTerminalString();
        File.AppendAllText(pathLogShuttle, $"[{DateTime.Now}] {formattedString}\n");

        await InvokeAsync(() =>
        {
            // Process types
            if (msg is TelemetryMessage tm) UpdateTelemetry(tm.Data);
            else if (msg is SensorMessage sm) UpdateSensors(sm.Data);
            else if (msg is StatsMessage stm) UpdateStats(stm.Data);
            else if (msg is ConfigMessage cm) UpdateConfig(cm.Data);

            LogToTerminal($"[{DateTime.Now:HH:mm:ss}] {formattedString}\n");
            StateHasChanged();
        });
    }

    private void UpdateTelemetry(TelemetryPacket data)
    {
        Shuttle.LastActivity = DateTime.Now;
        Shuttle.ErrorCode = data.ErrorCode;
        Shuttle.CurrentStatus = $"Status: {data.ShuttleStatus}";
        Shuttle.Position = data.CurrentPosition;
        Shuttle.CurrentSpeed = data.Speed;
        Shuttle.BatteryPercentage = data.BatteryCharge;
        Shuttle.BatteryVoltage = data.BatteryVoltage;
        Shuttle.StateFlags = data.StateFlags;

        // Map State Flags
        Shuttle.IsLifterUp = (data.StateFlags & 1) != 0;
        // Bit 1: motorStart, Bit 2: motorReverse, Bit 3: inverse, Bit 4: inChannel, Bit 5: fifoLifo
        Shuttle.IsInChannel = (data.StateFlags & 16) != 0;
        Shuttle.Inverse = (data.StateFlags & 8) != 0;
    }

    private void UpdateSensors(SensorPacket data)
    {
        Shuttle.LastActivity = DateTime.Now;
        Shuttle.ForwardDistance = data.DistanceF;
        Shuttle.ReverseDistance = data.DistanceR;
        Shuttle.ForwardPalletDistance = data.DistancePltF;
        Shuttle.ReversePalletDistance = data.DistancePltR;
        Shuttle.Angle = data.Angle;
        Shuttle.Temperature = data.Temperature;
        Shuttle.HardwareFlags = data.HardwareFlags;

        // Map Hardware Flags
        // Bit 0: detectPalleteF1, Bit 1: F2, Bit 2: R1, Bit 3: R2
        Shuttle.PalletDetectorFront1 = (data.HardwareFlags & 1) != 0 ? 1 : 0;
        Shuttle.PalletDetectorFront2 = (data.HardwareFlags & 2) != 0 ? 1 : 0;
        Shuttle.PalletDetectorRear1 = (data.HardwareFlags & 4) != 0 ? 1 : 0;
        Shuttle.PalletDetectorRear2 = (data.HardwareFlags & 8) != 0 ? 1 : 0;

        // Bit 4: BUMPER_F, Bit 5: BUMPER_R
        Shuttle.BumperForward = (data.HardwareFlags & 16) != 0 ? 1 : 0;
        Shuttle.BumperReverse = (data.HardwareFlags & 32) != 0 ? 1 : 0;

        // Bit 6: DL_UP, Bit 7: DL_DOWN
        Shuttle.IsLifterUp = (data.HardwareFlags & 64) != 0;
        Shuttle.IsLifterDown = (data.HardwareFlags & 128) != 0;
    }

    private void UpdateStats(StatsPacket data)
    {
        Shuttle.LastActivity = DateTime.Now;
        Shuttle.TotalDist = data.TotalDist;
        Shuttle.LoadCounter = data.LoadCounter;
        Shuttle.UnloadCounter = data.UnloadCounter;
        Shuttle.CompactCounter = data.CompactCounter;
        Shuttle.LiftUpCounter = data.LiftUpCounter;
        Shuttle.LiftDownCounter = data.LiftDownCounter;
        Shuttle.PalleteCount = data.PalleteCount;
    }

    private void UpdateConfig(ConfigPacket data)
    {
        switch ((ConfigParamID)data.ParamID)
        {
             case ConfigParamID.CFG_MAX_SPEED:
                 Shuttle.MaxSpeed = data.Value;
                 break;
             case ConfigParamID.CFG_INTER_PALLET:
                 Shuttle.InterPalleteDistance = data.Value;
                 break;
             case ConfigParamID.CFG_SHUTTLE_LEN:
                 Shuttle.ShuttleLength = data.Value;
                 break;
             case ConfigParamID.CFG_MIN_BATT:
                 Shuttle.BatteryLimit = data.Value;
                 break;
             case ConfigParamID.CFG_WAIT_TIME:
                 Shuttle.WaitTimeUnload = data.Value;
                 break;
             case ConfigParamID.CFG_CHNL_OFFSET:
                 Shuttle.ChannelOffset = data.Value;
                 break;
             case ConfigParamID.CFG_MPR_OFFSET:
                 Shuttle.ZeroPointMpr = data.Value;
                 break;
             case ConfigParamID.CFG_FIFO_LIFO:
                 Shuttle.FifoLifoMode = data.Value == 1 ? "LIFO" : "FIFO"; // Assuming mapping? Or just string?
                 break;
        }
    }

    private async Task SendBinaryCmd(CmdType cmd, int arg1 = 0, int arg2 = 0, string description = "")
    {
        if (!Shuttle.IsConnected || Shuttle.IPAddress is null)
        {
            LogToTerminal("[ERROR] –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n");
            return;
        }

        _isCommandInProgress = true;
        try
        {
            StateHasChanged();
            LogToTerminal($"[CMD] –û—Ç–ø—Ä–∞–≤–∫–∞: {cmd} ({description})\n");

            var success = await HubClientService.SendBinaryCommandAsync(Shuttle.IPAddress, cmd, arg1, arg2);
            if (!success) LogToTerminal($"[WARNING] –ö–æ–º–∞–Ω–¥–∞ {cmd} –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞\n");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã {Command} –∫ {IpAddress}", cmd, Shuttle.IPAddress);
            LogToTerminal($"[ERROR] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {ex.Message}\n");
        }
        finally
        {
            _isCommandInProgress = false;
            StateHasChanged();
        }
    }

    private async Task SendConfigSet(ConfigParamID param, int value, string description = "")
    {
        if (!Shuttle.IsConnected || Shuttle.IPAddress is null) return;

        _isCommandInProgress = true;
        try
        {
            StateHasChanged();
            LogToTerminal($"[CFG] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ {param}={value} ({description})\n");
            await HubClientService.SendConfigSetAsync(Shuttle.IPAddress, param, value);
        }
        catch (Exception ex)
        {
             LogToTerminal($"[ERROR] {ex.Message}\n");
        }
        finally
        {
            _isCommandInProgress = false;
            StateHasChanged();
        }
    }

    // Command Handlers
    private async Task SendStopCommand() => await SendBinaryCmd(CmdType.CMD_STOP, 0, 0, "–û—Å—Ç–∞–Ω–æ–≤–∫–∞");
    private async Task SendLoadCommand() => await SendBinaryCmd(CmdType.CMD_LOAD, 0, 0, "–ó–∞–≥—Ä—É–∑–∫–∞");
    private async Task SendLargeLoadCommand() => await SendBinaryCmd(CmdType.CMD_LONG_LOAD, 0, 0, "–î–ª–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞");
    private async Task SendUnloadCommand() => await SendBinaryCmd(CmdType.CMD_UNLOAD, 0, 0, "–í—ã–≥—Ä—É–∑–∫–∞");
    private async Task SendLargeUnloadCommand() => await SendBinaryCmd(CmdType.CMD_LONG_UNLOAD, 0, 0, "–î–ª–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞");

    private async Task SendManualShuttleCommand() => await SendBinaryCmd(CmdType.CMD_MANUAL_MODE, 0, 0, "–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º");
    private async Task SendDemoCommand() => await SendBinaryCmd(CmdType.CMD_DEMO, 0, 0, "–î–µ–º–æ-—Ä–µ–∂–∏–º");
    private async Task SendResetCommand() => await SendBinaryCmd(CmdType.CMD_RESET_ERROR, 0, 0, "–°–±—Ä–æ—Å –æ—à–∏–±–æ–∫");

    private async Task SendSaveSettingCommand() => await SendBinaryCmd(CmdType.CMD_SAVE_EEPROM, 0, 0, "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
    private async Task SendCalibrateCommand() => await SendBinaryCmd(CmdType.CMD_CALIBRATE, 0, 0, "–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —à–∞—Ç—Ç–ª–∞");
    private async Task SendGoHomeCommand() => await SendBinaryCmd(CmdType.CMD_HOME, 0, 0, "–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –¥–æ–º–æ–π");

    private async Task SetTime()
    {
        // Arg1 = Unix Timestamp
        int timestamp = (int)DateTimeOffset.UtcNow.ToUnixTimeSeconds();
        await SendBinaryCmd(CmdType.CMD_SET_DATETIME, timestamp, 0, "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏");
    }

    private async Task SendUseReverseModeShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_REVERSE_MODE, 1, "–†–µ–≤–µ—Ä—Å —Ä–µ–∂–∏–º");
    private async Task SendSealingForwardShuttleCommand() => await SendBinaryCmd(CmdType.CMD_COMPACT_F, 0, 0, "–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥");
    private async Task SendSealingBackShuttleCommand() => await SendBinaryCmd(CmdType.CMD_COMPACT_R, 0, 0, "–£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –Ω–∞–∑–∞–¥");

    private bool isReversed = false;
    private async Task SendReverseShuttleCommand()
    {
        if (!isReversed)
        {
            isReversed = true;
            await SendConfigSet(ConfigParamID.CFG_REVERSE_MODE, 1, "–†–µ–≤–µ—Ä—Å —Ä–µ–∂–∏–º on");
        }
        else
        {
            await SendConfigSet(ConfigParamID.CFG_REVERSE_MODE, 0, "–†–µ–≤–µ—Ä—Å —Ä–µ–∂–∏–º off");
            isReversed = false;
        }

    }

    private async Task SendUpShuttleCommand() => await SendBinaryCmd(CmdType.CMD_LIFT_UP, 0, 0, "–ü–æ–¥—ä—ë–º");
    private async Task SendLeftShuttleCommand() => await SendBinaryCmd(CmdType.CMD_MOVE_LEFT_MAN, 0, 0, "–¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–∑–∞–¥");
    private async Task SendRightShuttleCommand() => await SendBinaryCmd(CmdType.CMD_MOVE_RIGHT_MAN, 0, 0, "–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥");
    private async Task SendDownShuttleCommand() => await SendBinaryCmd(CmdType.CMD_LIFT_DOWN, 0, 0, "–°–ø—É—Å–∫");

    private async Task SendFRMFirmwareCommand() => await SendUpdateCommandAndOpenBrowser();
    private async Task SendUpdateStateShuttleCommand() => await SendUPDCommandAndOpenBrowser();
    private async Task SendRebootShuttleCommand() => await SendBinaryCmd(CmdType.CMD_SYSTEM_RESET, 0, 0, "Reboot shuttle");

    private async Task SendSetShuttleNumCommand()
    {
        await SendConfigSet(ConfigParamID.CFG_SHUTTLE_NUM, ShuttleNumberInput, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —à–∞—Ç—Ç–ª–∞: {ShuttleNumberInput}");
    }
    private async Task SendSetMoveReverseShuttleCommand() => await SendBinaryCmd(CmdType.CMD_MOVE_DIST_R, MoveDistanceBackwardInput, 0, $"–ü—Ä–æ–µ–∑–¥ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –Ω–∞–∑–∞–¥: {MoveDistanceBackwardInput} –º–º");
    private async Task SendMoveForwardShuttleCommand() => await SendBinaryCmd(CmdType.CMD_MOVE_DIST_F, MoveDistanceForwardInput, 0, $"–ü—Ä–æ–µ–∑–¥ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤–ø–µ—Ä—ë–¥: {MoveDistanceForwardInput} –º–º");
    private async Task SendSetMaxSpeedShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_MAX_SPEED, MaxSpeedInput, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏: {MaxSpeedInput}%");
    private async Task SendSetMinPowerShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_MIN_BATT, MinPowerInput, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã –±–∞—Ç–∞—Ä–µ–∏: {MinPowerInput}%");
    private async Task SendSetPalletBetweenDistanceShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_INTER_PALLET, PallentDistance, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ–∂–ø–∞–ª–ª–µ—Ç–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è: {PallentDistance}%");

    private async Task SendSetDistanceOfEdgeShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_CHNL_OFFSET, DistanceOfEdge, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –∫—Ä–∞—è: {DistanceOfEdge} –º–º");
    private async Task SendSetlenghtOfShuttleCommand() => await SendConfigSet(ConfigParamID.CFG_SHUTTLE_LEN, LenghtOfShuttle, $"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª–∏–Ω—ã —à–∞—Ç—Ç–ª–∞: {LenghtOfShuttle} –º–º");


    private async Task SendUpdateCommandAndOpenBrowser()
    {
        await SendBinaryCmd(CmdType.CMD_FIRMWARE_UPDATE, 0, 0, "–ü—Ä–æ—à–∏–≤–∫–∞");
        await OpenWebInterfaceAsync("FRM");
    }

    private async Task SendUPDCommandAndOpenBrowser()
    {
        // Assuming UPD also uses Firmware command or just opens browser?
        // Legacy sent "UPD".
        await SendBinaryCmd(CmdType.CMD_FIRMWARE_UPDATE, 0, 0, "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
        await OpenWebInterfaceAsync("UPD");
    }

    private async Task OpenWebInterfaceAsync(string argOpenBrowser)
    {
        var url = $"http://{Shuttle.IPAddress}/";
        if (argOpenBrowser == "UPD")
        {
            url += "update";
        }
        try
        {
            var uri = new Uri(url);
            await WebBrowserService.OpenBrowserAsync(uri);
            LogToTerminal($"[INFO] –û—Ç–∫—Ä—ã—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {url}\n");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ {Url}", url);
            LogToTerminal($"[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä: {ex.Message}\n");
        }
    }

    private async Task SendManualCommand()
    {
        if (!string.IsNullOrWhiteSpace(_manualCommand))
        {
             // Try to parse command? Or just send raw?
             // Since we don't have text command support, we can't do much.
             // Maybe user enters "5" for stop?
             if (Enum.TryParse(_manualCommand, true, out CmdType result))
             {
                  await SendBinaryCmd(result, 0, 0, "–†—É—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞");
             }
             else
             {
                 LogToTerminal($"[ERROR] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ '{_manualCommand}'. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, CMD_STOP)\n");
             }
            _manualCommand = "";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendManualCommand();
        }
    }

    private async Task DisconnectThis()
    {
        if (Shuttle.IPAddress == null)
        {
            throw new Exception("ip is null");
        }
        else
        {
            HubClientService.DisconnectFromShuttle(Shuttle.IPAddress);
            LogToTerminal("[INFO] –ó–∞–ø—Ä–æ—à–µ–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ\n");
            await OnDisconnected.InvokeAsync(Shuttle.IPAddress);
        }

    }

    private void ClearTerminal()
    {
        Shuttle.ClearTerminalMessage();
        _terminalOutputHtml = "";
        StateHasChanged();
    }

    private void LogToTerminal(string message)
    {
        var lines = message.Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries);

        Shuttle.AddTerminalMessage(message);

        if (Shuttle.GetTerminalMessages().Count > 1000)
        {
            Shuttle.RemoveTerminalMessage();
        }

        _terminalOutputHtml = string.Join("",
            Shuttle.GetTerminalMessages().Select(line =>
                $"<div class=\"terminal-line\">{System.Net.WebUtility.HtmlEncode(line)}</div>"));
        StateHasChanged();
        _ = ScrollTerminalToBottomAsync();
    }

    private async Task ScrollTerminalToBottomAsync()
    {
        try
        {
            var elementId = $"terminalContainer_{_componentId}";
            await JSRuntime.InvokeVoidAsync("scrollToBottomIfNeeded", elementId);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "–û—à–∏–±–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ScrollTerminalToBottomAsync();
        }
    }

    private string GetBatteryColorClass() => BatteryPercentageValue switch
    {
        >= 70 => "text-success",
        >= 30 => "text-warning",
        _ => "text-danger"
    };

    private string GetBatteryProgressClass() => BatteryPercentageValue switch
    {
        >= 70 => "bg-success",
        >= 30 => "bg-warning",
        _ => "bg-danger"
    };

    private string GetStatusColorClass() => CurrentStatus.ToLowerInvariant() switch
    {
        string s when s.Contains("–æ—à–∏–±–∫–∞") || s.Contains("error") => "text-danger",
        string s when s.Contains("–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ") || s.Contains("warning") => "text-warning",
        string s when s.Contains("—Ä–∞–±–æ—Ç–∞") || s.Contains("work") => "text-success",
        _ => "text-secondary"
    };

    private async Task ChoiceFile()
    {
        var file = await FilePickerService.PickFileAsync();
        _selectedFile = file?.FilePath;
    }

    public void Dispose()
    {
        Logger.LogInformation("–î–∏—Å–∫–æ–Ω–Ω–µ–∫—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è IP: {IpAddress}", Shuttle.IPAddress);

        _componentCts.Cancel();
        _componentCts.Dispose();

        _otaCts.Cancel();
        _otaCts.Dispose();

        HubClientService.Connected -= OnHubConnected;
        HubClientService.Disconnected -= OnHubDisconnected;
        HubClientService.LogReceived -= OnLogReceived;
    }
}
