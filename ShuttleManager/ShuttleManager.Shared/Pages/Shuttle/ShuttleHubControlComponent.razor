@using System.Diagnostics
@using ShuttleManager.Shared.Interfaces
@inject IJSRuntime JSRuntime
@using System.Text.Json.Nodes
@using Microsoft.Extensions.Logging
@using ShuttleManager.Shared.Services
@inject IBrowserLauncherService BrowserLauncher
@inject IShuttleHubClientService HubClientService
@inject ILogger<ShuttleHubControlComponent> Logger
@using ShuttleManager.Shared.Models
@inject IFilePickerService FilePickerService
@inject NavigationManager Navigation

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            Шаттл №: @SeeCorrentNumberShuttle(Shuttle.ShuttleNumber)
            <span class="badge @(IsConnected ? "bg-success" : "bg-warning") ms-2">
                @(IsConnected ? "Подключен" : "Подключение...")
            </span>
        </h5>
        <div>
            <button class="btn btn-sm btn-danger" @onclick="DisconnectThis" title="Отключиться">
                <i class="bi bi-power"></i> Закрыть
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (!IsConnected)
        {
            <div class="alert alert-warning mb-3 d-flex align-items-center">
                <i class="bi bi-hourglass-split me-2"></i>
                <div>
                    <strong>Подключение к @Shuttle.IPAddress...</strong>
                    @if (_connectionAttempts > 0)
                    {
                        <div class="small">Попытка @_connectionAttempts</div>
                    }
                </div>
            </div>
        }
        else
        {
            //telemetry old
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Батарея:</label>
                        <p id="batteryData_@ComponentId" class="fw-bold @GetBatteryColorClass()">
                            @BatteryData
                        </p>
                    </div>
@*                     <div class="col-md-3">
                        <label class="form-label small text-muted">Заряд:</label>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar @GetBatteryProgressClass()"
                                 role="progressbar"
                                 style="width: @(BatteryPercentageValue)%;"
                                 aria-valuenow="@BatteryPercentageValue"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                @BatteryPercentageValue%
                            </div>
                        </div>
                    </div> *@
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Статус:</label>
                        <p id="currentStatus_@ComponentId" class="fw-bold @GetStatusColorClass()">
                            @CurrentStatus
                        </p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Активность:</label>
                        <p class="small text-muted">@LastActivityTime</p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Время работы:</label>
                        <p class="small text-muted">@Uptime</p>
                    </div>
                </div>

@*                 <div class="row mt-2">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Напряжение:</label>
                        <p id="voltage_@ComponentId" class="fw-bold">
                            @Voltage.ToString("F1") V
                        </p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Код ошибки:</label>
                        <p id="errorCode_@ComponentId" class="fw-bold @(ErrorCode != 0 ? "text-danger" : "text-success")">
                            @(ErrorCode == 0 ? "Нет" : ErrorCode.ToString())
                        </p>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Код предупреждения:</label>
                        <p id="warningCode_@ComponentId" class="fw-bold @(WarningCode != 0 ? "text-warning" : "text-success")">
                            @(WarningCode == 0 ? "Нет" : WarningCode.ToString())
                        </p>
                    </div>                 
                </div> *@

            </div>
            //telemetry old
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-7">
                        <div class="card mb-2" >
                            <div class="card-body p-2" style="height: 100%">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label>Терминал: </label>
                                    <div style="height: 100%">
                                        <button class="btn btn-sm btn-outline-danger me-1" @onclick="ClearTerminal" title="Очистить терминал">
                                            <i class="bi bi-trash">❌</i>
                                        </button>
                                        <span class="badge bg-secondary">@Shuttle.GetTerminalMessages().Count строк</span>
                                    </div>
                                </div>
                                <div id="terminalContainer_@ComponentId"
                                     class="terminal-container border rounded"
                                     style="height: 448px;">
                                    @((MarkupString)TerminalOutputHtml)
                                </div>
                                <div class="input-group input-group-sm mt-2">
                                    <span class="input-group-text">
                                        <i class="bi bi-terminal"></i>
                                    </span>
                                    <InputText @bind-Value="ManualCommand"
                                               class="form-control form-control-sm"
                                               placeholder="Введите команду..."
                                               @onkeypress="HandleKeyPress"
                                               disabled="@(!IsConnected || _isCommandInProgress)" />
                                    <button class="btn btn-primary btn-sm"
                                            @onclick="SendManualCommand">
                                        <i class="bi bi-send"></i> Отпр
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div class="row g-1">
                                        <div class="col-6 mb-1">
                                            <button class="btn btn-danger btn-sm w-100" @onclick="SendResetCommand" title="Сброс текущих ошибок">
                                                <i class="bi bi-arrow-counterclockwise me-1"></i>Сброс ошибок
                                            </button>
                                        </div>
                                        <div class="col-6 mb-1">
                                            <button class="btn btn-secondary btn-sm w-100" @onclick="SendCalibrateCommand" title="Запуск процедуры калибровки">
                                                <i class="bi bi-rulers me-1"></i>Калибровка
                                            </button>
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-danger btn-sm w-100 " @onclick="SendRebootShuttleCommand" title="Полная перезагрузка шаттла">
                                                <i class="bi bi-arrow-repeat me-1"></i>ребут
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendFRMFirmwareCommand" title="Открыть веб-интерфейс обновления прошивки">
                                                    <i class="bi bi-cloud-arrow-up me-1"></i>Обновление прошивки платы (FRM)
                                                </button>
                                            </div>
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendUpdateStateShuttleCommand" title="Применить загруженное обновление">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Обновление прошивки экрана (UPD)
                                                </button>
                                            </div>
                                           
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="SetTime" title="Установить время">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Установить время
                                                </button>
                                            </div>
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="OpenLogsShuttle" title="Открыть логи шаттла" disabled="@(OperatingSystem.IsAndroid())">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Логи шаттла
                                                </button>
                                            </div>
                                           
                                            <div class="mb-1">
                                                <button class="btn btn-outline-primary btn-sm w-100" @onclick="FilePock" title="OTA прошивка">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>!DEBUG! OTA прошивка
                                                </button>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="row g-2">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">Команды</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendLoadCommand" title="Запуск цикла загрузки">
                                                    <i class="bi bi-upload me-1"></i>Загрузка ↗
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendLargeLoadCommand" title="Запуск продолжительного цикла загрузки">
                                                    <i class="bi bi-upload me-1"></i>П. Загрузка ↗↗
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendUnloadCommand" title="Запуск цикла выгрузки">
                                                    <i class="bi bi-download me-1"></i>Выгрузка ↘
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendLargeUnloadCommand" title="Запуск продолжительного цикла выгрузки">
                                                    <i class="bi bi-download me-1"></i>П. Выгрузка ↘↘
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-success btn-sm w-100" @onclick="SendSealingForwardShuttleCommand" title="Уплотнение вперед">
                                                    <i class="bi bi-arrows-angle-contract me-1"></i>Уплотнение вперёд
                                                </button>
                                            </div>
                                            <div class="col-6 mb-1">
                                                <button class="btn btn-warning btn-sm w-100" @onclick="SendSealingBackShuttleCommand" title="Уплотнение назад">
                                                    <i class="bi bi-arrows-angle-expand me-1"></i>Уплотнение назад
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">Управление</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-info btn-sm w-100 p-2" @onclick="SendDemoCommand" title="Запуск демонстрационного режима">
                                                    <i class="bi bi-play-circle me-1"></i>Демо-режим
                                                </button>
                                            </div>
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendUpShuttleCommand" title="Движение вперёд">
                                                    <i class="bi bi-arrow-up-square me-1"></i>↑ вверх ↑
                                                </button>
                                            </div>
                                            <div class="col-4 mb-1">
                                                <button class="btn btn-warning btn-sm w-100 p-2" @onclick="SendSetMoveReverseShuttleCommand" title="Реверс" disabled>
                                                    <i class="bi bi-download me-1"></i>Реверс 🔄
                                                </button>
                                            </div>

                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendLeftShuttleCommand" title="Движение влево">
                                                    <i class="bi bi-arrow-left-square me-1"></i>← назад ←
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendDownShuttleCommand" title="Движение назад">
                                                    <i class="bi bi-arrow-down-square me-1"></i>↓ вниз ↓
                                                </button>
                                            </div>
                                            <div class="col-4">
                                                <button class="btn btn-primary btn-sm w-100 p-2" @onclick="SendRightShuttleCommand" title="Движение вправо">
                                                    <i class="bi bi-arrow-right-square me-1"></i>→ вперёд →
                                                </button>
                                            </div>

                                            <div class="col-12 mb-1">
                                                <button class="btn btn-danger btn-sm w-100 p-3" @onclick="SendStopCommand" title="Экстренная остановка всех операций">
                                                    <i class="bi bi-stop-circle-fill me-1"></i><strong>STOP</strong>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Параметры (новая секция) -->
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header p-1">
                                        <h6 class="fw-bold text-muted mb-0">Параметры</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-1">
                                            <!-- Номер шаттла -->
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="ShuttleNumberInput" class="form-control form-control-sm" min="1" max="999" placeholder="Номер шаттла" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="1" @onclick="SendSetShuttleNumCommand" title="Установить номер шаттла">
                                                        Установить номер шаттла
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Расстояние назад -->
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MoveDistanceBackwardInput" class="form-control form-control-sm" min="0" max="10000" step="10" placeholder="Расст. назад (мм)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetMoveReverseShuttleCommand" title="Проезд заданного расстояния назад">
                                                        Движение назад, мм ⮜⮜
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Расстояние вперёд -->
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MoveDistanceForwardInput" class="form-control form-control-sm" min="0" max="10000" step="10" placeholder="Расст. вперёд (мм)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendMoveForwardShuttleCommand" title="Проезд заданного расстояния вперёд">
                                                        Движение вперёд, мм ⮞⮞
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Макс. скорость -->
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MaxSpeedInput" class="form-control form-control-sm" min="5" max="100" step="1" placeholder="Макс. скорость (%)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="5" @onclick="SendSetMaxSpeedShuttleCommand" title="Установить максимальную скорость">
                                                        Установить максимальную скорость, % V
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Мин. мощность -->
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="MinPowerInput" class="form-control form-control-sm" min="0" max="100" step="1" placeholder="Мин. уровень (%)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetMinPowerShuttleCommand" title="Установить Уровень защиты батареи">
                                                        Уровень защиты батареи, %
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-12 mb-1">
                                                <div class="input-group input-group-sm">
                                                    <InputNumber @bind-Value="PallentDistance" class="form-control form-control-sm" min="0" max="500" step="10" placeholder="меж. паллет. растояние (мм)" />
                                                    <button class="btn btn-secondary btn-sm w-75" value="0" @onclick="SendSetPalletBetweenDistanceShuttleCommand" title="Установить межпаллетное расстояние">
                                                        Межпаллетное расстояние, мм ↔
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-1 mt-1">
                                            <button class="btn btn-outline-primary btn-sm w-100" @onclick="SendSaveSettingCommand" title="Сохранить текущие параметры в память">
                                                <i class="bi bi-save me-1"></i>Сохранить настройки
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public Shuttle Shuttle { get; set; } = null!;
    [Parameter] public EventCallback<string> OnDisconnected { get; set; }

    private int ShuttleNumberInput = 0;
    private int MoveDistanceBackwardInput = 0;
    private int MoveDistanceForwardInput = 0;
    private int MaxSpeedInput = 0;
    private int MinPowerInput = 0; 
    private int PallentDistance = 0;

    private bool isAndroid => OperatingSystem.IsAndroid();

    //private readonly List<string> _terminalLines = new();
    private string _terminalOutputHtml = "";
    private string _manualCommand = "";
    private string _componentId = Guid.NewGuid().ToString();
    private bool _isCommandInProgress;
    private int _connectionAttempts;
    private CancellationTokenSource _componentCts = new();

    private string CurrentStatus => Shuttle.CurrentStatus;
    private int ErrorCode => Shuttle.ErrorCode;
    private int WarningCode => Shuttle.WarningCode;
    private double Voltage => Shuttle.BatteryVoltage;
    private int BatteryPercentageValue => Shuttle.BatteryPercentage;
    private string LastActivityTime => Shuttle.LastActivity.ToString("HH:mm:ss");
    private string Uptime => (DateTime.Now - Shuttle.ConnectionTime).ToString(@"hh\:mm\:ss");
    private string BatteryData => $"Батарея: {Shuttle.BatteryVoltage:F1}V | Заряд: {Shuttle.BatteryPercentage}%";
    private bool IsConnected => Shuttle.IsConnected;
    private string ComponentId => _componentId;
    //private List<string> TerminalLines => _terminalLines;
    private string TerminalOutputHtml => _terminalOutputHtml;
    private string ManualCommand { get => _manualCommand; set => _manualCommand = value; }
    private string pathLogShuttle = "";

    private readonly List<string> _statusBlockLines = new(); // Для сбора строк блока статуса
    private bool _inStatusBlock = false; // Флаг, находимся ли мы внутри блока статуса



    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (!Directory.Exists($"{AppContext.BaseDirectory}/logs"))
            {
                Directory.CreateDirectory($"{AppContext.BaseDirectory}/logs");
            }          
            HubClientService.Connected += OnHubConnected;
            HubClientService.Disconnected += OnHubDisconnected;
            HubClientService.TelemetryReceived += OnTelemetryReceived;
            HubClientService.LogReceived += OnLogReceived;
            pathLogShuttle = Path.Combine($"{AppContext.BaseDirectory}/logs", $"Shuttle_Log_Number_{DateTime.Now.Day}_{DateTime.Now.Month}_{DateTime.Now.Year}_{Shuttle.IPAddress}.txt");
            Logger.LogInformation("Компонент инициализирован для {IpAddress}", Shuttle.IPAddress);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка инициализации компонента для {IpAddress}", Shuttle.IPAddress);
            LogToTerminal($"[ERROR] Ошибка инициализации: {ex.Message}\n");
        }
    }

    private string SeeCorrentNumberShuttle (string numberShuttle)
    {
        if (char.IsDigit(numberShuttle[0]))
        {
            return numberShuttle;
        }
        else
        {
            return numberShuttle.Substring(1);
        }
    }

    private bool IsEventForThisShuttle(string ipAddress)
    {
        return ipAddress == Shuttle.IPAddress;
    }

    private async void OnHubConnected(string ip, int id)
    {
        if (!IsEventForThisShuttle(ip)) return;

        await InvokeAsync(() =>
        {
            Shuttle.IsConnected = true;
            Shuttle.ConnectionTime = DateTime.Now;
            Shuttle.LastActivity = DateTime.Now;
            LogToTerminal($"[SUCCESS] Подключено к шаттлу ID: {id}\n");
            StateHasChanged();
        });
    }

    private async void OnHubDisconnected(string ip)
    {
        if (!IsEventForThisShuttle(ip)) return;

        await InvokeAsync(() =>
        {
            Shuttle.IsConnected = false;
            LogToTerminal("[WARNING] Соединение разорвано\n");
            StateHasChanged();
            _ = OnDisconnected.InvokeAsync(ip);
        });
    }

    private async void OnTelemetryReceived(string ip, JsonNode telemetry)
    {
        if (!IsEventForThisShuttle(ip)) return;

        await InvokeAsync(() =>
        {
            try
            {
                ProcessTelemetryData(telemetry);
                Shuttle.LastActivity = DateTime.Now;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Ошибка обработки телеметрии от {IpAddress}", ip);
            }
        });
    }

    private void ProcessTelemetryData(JsonNode telemetry)
    {
        var id = telemetry["id"]?.GetValue<string>() ?? "";
        var batt = telemetry["batt"]?.GetValue<int>() ?? 0;
        var volt = telemetry["volt"]?.GetValue<double>() ?? 0.0;
        var stateStr = telemetry["state_s"]?.ToString() ?? "Неизвестно";
        var err = telemetry["err"]?.GetValue<int>() ?? 0;
        var warn = telemetry["warn"]?.GetValue<int>() ?? 0;

        //Shuttle.ShuttleNumber = id;
        Shuttle.BatteryPercentage = batt;
        Shuttle.BatteryVoltage = volt;
        Shuttle.CurrentStatus = stateStr;
        Shuttle.ErrorCode = err;
        Shuttle.WarningCode = warn;
    }

    private void ParseAndHandleResponse(string response)
    {
        var line = response.Trim();

        // --- Парсинг CB XX ---
        var cbMatch = System.Text.RegularExpressions.Regex.Match(line, @"^CB\s+(\d+)$");
        if (cbMatch.Success && int.TryParse(cbMatch.Groups[1].Value, out int batteryPercentageScr))
        {
            Shuttle.BatteryPercentage = batteryPercentageScr;
            Logger.LogInformation($"Parsed CB: Battery {batteryPercentageScr}%");
            return; // Возврат, чтобы не попало в терминал дважды
        }

        // --- Парсинг Batt voltage строки ---
        var battMatch = System.Text.RegularExpressions.Regex.Match(line, @"Batt voltage = ([\d.]+)V Charge = (\d+)% limit = (\d+)%");
        if (battMatch.Success)
        {
            if (double.TryParse(battMatch.Groups[1].Value, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out double batteryVoltage) &&
                int.TryParse(battMatch.Groups[2].Value, out int batteryPercentage) &&
                int.TryParse(battMatch.Groups[3].Value, out int batteryLimit))
            {
                Shuttle.BatteryVoltage = batteryVoltage;
                Shuttle.BatteryPercentage = batteryPercentage;
                Shuttle.BatteryLimit = batteryLimit;
                Logger.LogInformation($"Parsed Batt: {batteryVoltage}V {batteryPercentage}% {batteryLimit}%");
            }
            return; // Возврат
        }

        // --- Парсинг Inverse ---
        var inverseMatch = System.Text.RegularExpressions.Regex.Match(line, @"Inverse = (YES|NO)");
        if (inverseMatch.Success)
        {
            Shuttle.Inverse = inverseMatch.Groups[1].Value == "YES";
            Logger.LogInformation($"Parsed Inverse: {Shuttle.Inverse}");
            return; // Возврат
        }

        // --- Парсинг Status ---
        var statusMatch = System.Text.RegularExpressions.Regex.Match(line, @"Status = (.+?)\s+\((\d+)\)");
        if (statusMatch.Success)
        {
            Shuttle.CurrentStatus = statusMatch.Groups[1].Value.Trim();
            if (int.TryParse(statusMatch.Groups[2].Value, out int statusCode))
            {
                Shuttle.StatusCode = statusCode;
            }
            // CurrentCommand, кажется, не из этого лога, но если нужно, можно присвоить CurrentStatus
            // Shuttle.CurrentCommand = Shuttle.CurrentStatus;
            Logger.LogInformation($"Parsed Status: {Shuttle.CurrentStatus} ({Shuttle.StatusCode})");
            return; // Возврат
        }

        // --- Парсинг MPR и Max Speed ---
        var mprMatch = System.Text.RegularExpressions.Regex.Match(line, @"MPR = (\d+)\s+max speed = (\d+)");
        if (mprMatch.Success)
        {
            if (int.TryParse(mprMatch.Groups[1].Value, out int interPalletDistance) &&
                int.TryParse(mprMatch.Groups[2].Value, out int maxSpeed))
            {
                Shuttle.InterPalleteDistance = interPalletDistance; // Используем как MPR
                Shuttle.MaxSpeed = maxSpeed; // Текущая max speed из статуса
                Logger.LogInformation($"Parsed MPR/MaxSp: MPR={interPalletDistance}, MaxSp={maxSpeed}");
            }
            return; // Возврат
        }

        // --- Парсинг Shuttle Number и Length ---
        var shuttleMatch = System.Text.RegularExpressions.Regex.Match(line, @"Shuttle number = (\d+)\s+Shuttle length = (\d+)");
        if (shuttleMatch.Success)
        {
            if (int.TryParse(shuttleMatch.Groups[1].Value, out int shuttleNumber) &&
                int.TryParse(shuttleMatch.Groups[2].Value, out int shuttleLength))
            {
                //Shuttle.ShuttleNumber = shuttleNumber.ToString(); // Предполагаем, что в модели это строка
                Shuttle.ShuttleLength = shuttleLength;
                Logger.LogInformation($"Parsed Shuttle: Num={Shuttle.ShuttleNumber}, Len={shuttleLength}");
            }
            return; // Возврат
        }

        // --- Парсинг Temperature ---
        var tempMatch = System.Text.RegularExpressions.Regex.Match(line, @"Temperature = ([\d.]+)");
        if (tempMatch.Success)
        {
            if (double.TryParse(tempMatch.Groups[1].Value, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out double temperature))
            {
                Shuttle.Temperature = temperature;
                Logger.LogInformation($"Parsed Temp: {temperature}°C");
            }
            return; // Возврат
        }

        // --- Парсинг Angle, Length, Position ---
        var angleMatch = System.Text.RegularExpressions.Regex.Match(line, @"Angle = (\d+)\s*\|\s*Lenght = (\d+)\s*\|\s*position = (\d+)");
        if (angleMatch.Success)
        {
            if (int.TryParse(angleMatch.Groups[1].Value, out int angle) &&
                int.TryParse(angleMatch.Groups[2].Value, out int length) &&
                int.TryParse(angleMatch.Groups[3].Value, out int position))
            {
                Shuttle.Angle = angle;
                Shuttle.Length = length; // Проверьте, может быть конфликт с длиной шаттла?
                Shuttle.Position = position;
                Logger.LogInformation($"Parsed Angle/Length/Pos: {angle}/{length}/{position}");
            }
            return; // Возврат
        }

        // --- Парсинг FIFO/LIFO ---
        var fifoLifoMatch = System.Text.RegularExpressions.Regex.Match(line, @"FIFO_LIFO = (FIFO|LIFO)");
        if (fifoLifoMatch.Success)
        {
            Shuttle.FifoLifoMode = fifoLifoMatch.Groups[1].Value;
            Logger.LogInformation($"Parsed FIFO/LIFO: {Shuttle.FifoLifoMode}");
            return; // Возврат
        }

        // --- Парсинг Forward/Reverse Distances ---
        var distMatch = System.Text.RegularExpressions.Regex.Match(line, @"Forwrd dist = (\d+)\s*\|\s*Revrs dist = (\d+)");
        if (distMatch.Success)
        {
            if (int.TryParse(distMatch.Groups[1].Value, out int forwardDist) &&
                int.TryParse(distMatch.Groups[2].Value, out int reverseDist))
            {
                Shuttle.ForwardDistance = forwardDist;
                Shuttle.ReverseDistance = reverseDist;
                Logger.LogInformation($"Parsed Dist F/R: {forwardDist}/{reverseDist}");
            }
            return; // Возврат
        }

        // --- Парсинг Forward/Reverse Pallet Distances ---
        var pltDistMatch = System.Text.RegularExpressions.Regex.Match(line, @"Forwrd plt dist = (\d+)\s*\|\s*Revrs plt dist = (\d+)");
        if (pltDistMatch.Success)
        {
            if (int.TryParse(pltDistMatch.Groups[1].Value, out int forwardPalletDist) &&
                int.TryParse(pltDistMatch.Groups[2].Value, out int reversePalletDist))
            {
                Shuttle.ForwardPalletDistance = forwardPalletDist;
                Shuttle.ReversePalletDistance = reversePalletDist;
                Logger.LogInformation($"Parsed Pallet Dist F/R: {forwardPalletDist}/{reversePalletDist}");
            }
            return; // Возврат
        }

        // --- Парсинг Pallet Detectors ---
        var pltDetMatch = System.Text.RegularExpressions.Regex.Match(line, @"Plt dtchk (F1|R1) = (\d+)\s*\|\s*Plt dtchk (F2|R2) = (\d+)");
        if (pltDetMatch.Success)
        {
            string side = pltDetMatch.Groups[1].Value.Substring(0, 1); // F или R
            if (int.TryParse(pltDetMatch.Groups[2].Value, out int detector1) &&
                int.TryParse(pltDetMatch.Groups[4].Value, out int detector2))
            {
                if (side == "F")
                {
                    Shuttle.PalletDetectorFront1 = detector1;
                    Shuttle.PalletDetectorFront2 = detector2;
                }
                else if (side == "R") // side == "R"
                {
                    Shuttle.PalletDetectorRear1 = detector1;
                    Shuttle.PalletDetectorRear2 = detector2;
                }
                Logger.LogInformation($"Parsed Pallet Det {side}: {detector1}/{detector2}");
            }
            return; // Возврат
        }

        // --- Парсинг In Channel ---
        var inChanMatch = System.Text.RegularExpressions.Regex.Match(line, @"In channel:\s+(YES|NO)");
        if (inChanMatch.Success)
        {
            Shuttle.IsInChannel = inChanMatch.Groups[1].Value == "YES";
            Logger.LogInformation($"Parsed In Channel: {Shuttle.IsInChannel}");
            return; // Возврат
        }

        // --- Парсинг Lifter ---
        var lifterMatch = System.Text.RegularExpressions.Regex.Match(line, @"Lifter UP:\s+(YES|NO)\s*\|\s*Lifter DOWN:\s+(YES|NO)");
        if (lifterMatch.Success)
        {
            Shuttle.IsLifterUp = lifterMatch.Groups[1].Value == "YES";
            Shuttle.IsLifterDown = lifterMatch.Groups[2].Value == "YES";
            Logger.LogInformation($"Parsed Lifter: UP={Shuttle.IsLifterUp}, DOWN={Shuttle.IsLifterDown}");
            return; // Возврат
        }

        // --- Парсинг Bumpers ---
        var bumperMatch = System.Text.RegularExpressions.Regex.Match(line, @"Bumper forward = (\d+)\s*\|\s*Bumper reverse = (\d+)");
        if (bumperMatch.Success)
        {
            if (int.TryParse(bumperMatch.Groups[1].Value, out int bumperForward) &&
                int.TryParse(bumperMatch.Groups[2].Value, out int bumperReverse))
            {
                Shuttle.BumperForward = bumperForward;
                Shuttle.BumperReverse = bumperReverse;
                Logger.LogInformation($"Parsed Bumper F/R: {bumperForward}/{bumperReverse}");
            }
            return; // Возврат
        }

        // --- Парсинг Zero Point MPR и Channel Offset ---
        var zeroOffMatch = System.Text.RegularExpressions.Regex.Match(line, @"Zero point MPR = (\d+)\s+channel offset = (\d+)");
        if (zeroOffMatch.Success)
        {
            if (int.TryParse(zeroOffMatch.Groups[1].Value, out int zeroPointMpr) &&
                int.TryParse(zeroOffMatch.Groups[2].Value, out int channelOffset))
            {
                Shuttle.ZeroPointMpr = zeroPointMpr;
                Shuttle.ChannelOffset = channelOffset;
                Logger.LogInformation($"Parsed Zero/Offset: {zeroPointMpr}/{channelOffset}");
            }
            return; // Возврат
        }

        // --- Парсинг Wait Time Unload ---
        var waitTimeMatch = System.Text.RegularExpressions.Regex.Match(line, @"Wait time on unload = (\d+)\s+Sec");
        if (waitTimeMatch.Success)
        {
            if (int.TryParse(waitTimeMatch.Groups[1].Value, out int waitTime))
            {
                Shuttle.WaitTimeUnload = waitTime;
                Logger.LogInformation($"Parsed Wait Time: {waitTime}s");
            }
            return; // Возврат
        }

        // Если строка не подошла ни под одно правило, логируем как нераспознанную (опционально)
        // Logger.LogDebug($"Unrecognized log line: {line}");
    }


    private async void OnLogReceived(string ip, string log)
    {
        if (!IsEventForThisShuttle(ip)) return;

        File.AppendAllText(pathLogShuttle, $"[{DateTime.Now}] {log}\n");

        await InvokeAsync(() =>
        {
            // --- Парсинг строки (вызывается для каждой строки) ---
            ParseAndHandleResponse(log);

            // --- Обработка блока статуса (для внутреннего использования, например, FullStatusBlock) ---
            if (log.StartsWith("-----------------------------------------------"))
            {
                if (!_inStatusBlock)
                {
                    _inStatusBlock = true;
                    _statusBlockLines.Clear();
                }
                else
                {
                    _inStatusBlock = false;
                    Shuttle.FullStatusBlock = string.Join("\n", _statusBlockLines); // Сохраняем блок, если нужно
                }
            }
            else if (_inStatusBlock)
            {
                _statusBlockLines.Add(log);
            }

            // --- ОРИГИНАЛЬНАЯ ЛОГИКА ДОБАВЛЕНИЯ В ТЕРМИНАЛ ---
            if (log.Contains("##HEARTBEAT##"))
            {
                LogToTerminal($"[HEARTBEAT] {log}\n");
            }
            else
            {
                var cleanLog = log.Contains("##TELEMETRY##") ? log.Substring(0, log.IndexOf("##TELEMETRY##")) : log;
                // ВСЕ остальные строки, включая "online...", "CB XX", и строки статуса, идут в терминал
                LogToTerminal($"[{DateTime.Now}] {cleanLog}\n");
            }

            // --- Обновление UI ---
            StateHasChanged(); // Обновляем UI после изменения данных Shuttle
        });
    }

    private async Task SendCommandAsync(string command, string description = "")
    {
        if (!Shuttle.IsConnected)
        {
            LogToTerminal("[ERROR] Нет подключения\n");
            return;
        }

        _isCommandInProgress = true;
        try
        {
            StateHasChanged();

            var displayCommand = string.IsNullOrEmpty(description) ? command : $"{command} ({description})";
            LogToTerminal($"[CMD] Отправка: {displayCommand}\n");

            var success = await HubClientService.SendCommandToShuttleAsync(Shuttle.IPAddress, command, 1000);
        }
        catch (OperationCanceledException)
        {
            LogToTerminal($"[WARNING] Команда отменена: {command}\n");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка отправки команды {Command} к {IpAddress}", command, Shuttle.IPAddress);
            LogToTerminal($"[ERROR] Исключение при отправке: {ex.Message}\n");
        }
        finally
        {
            _isCommandInProgress = false;
            StateHasChanged();
        }
    }

    private async Task SendSetShuttleNumCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dNN{ShuttleNumberInput}", $"Установка номера шаттла: {ShuttleNumberInput}");
    }

    private async Task SendSetMoveReverseShuttleCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dMf{MoveDistanceBackwardInput}", $"Проезд расстояния назад: {MoveDistanceBackwardInput} мм");
    }

    private async Task SendMoveForwardShuttleCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dMr{MoveDistanceForwardInput}", $"Проезд расстояния вперёд: {MoveDistanceForwardInput} мм");
    }

    private async Task SendSetMaxSpeedShuttleCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dSp{MaxSpeedInput}", $"Установка максимальной скорости: {MaxSpeedInput}%");
    }

    //TODO - уровень защиты батареи.
    private async Task SendSetMinPowerShuttleCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dBc{MinPowerInput}", $"Установка лимита батареи: {MinPowerInput}%");
    }

    private async Task SendSetPalletBetweenDistanceShuttleCommand()
    {
        await SendCommandAsync($"{Shuttle.ShuttleNumber}dDm{PallentDistance}", $"Установка межпаллетного расстояния: {PallentDistance}%");
    }

    private async Task SetTime()
    {
        DateTime currentTime = DateTime.Now;
        string command = $"DT {currentTime:HH:mm:ss dd/MM/yyyy}";
        await SendCommandAsync(command);
    }

    private async Task OpenLogsShuttle()
    {
        if (isAndroid)
        {
            return;
        }
        string way = Path.Combine(AppContext.BaseDirectory, "logs");
        Process.Start("explorer.exe", way);
    }

    private async Task FilePock()
    {
        await SendCommandAsync("FRM", "Прошивка");
        await Task.Delay(1000);
        Navigation.NavigateTo($"/esp-ota/{Shuttle.IPAddress}");
        //var result = await FilePickerService.PickFileAsync();
    }

    // --- Все методы отправки команд ---
    private async Task SendStopCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dStop_", "Остановка");
    private async Task SendLoadCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dLoad_", "Загрузка");
    private async Task SendLargeLoadCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dLLoad", "Длительная загрузка");
    private async Task SendUnloadCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dUnld_", "Выгрузка");
    private async Task SendLargeUnloadCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dLUnld", "Длительная выгрузка");

    private async Task SendManualShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dManua", "Ручной режим");
    private async Task SendDemoCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dDemo_", "Демо-режим");
    private async Task SendResetCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dReset", "Сброс ошибок");

    private async Task SendSaveSettingCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dSaveC", "Сохранение настроек");
    private async Task SendCalibrateCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dClbr_", "Калибровка шаттла");
    private async Task SendGoHomeCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dHome_", "Возвращение домой");

    private async Task SendSetTimeShuttleCommand() => await SendCommandAsync("DT", "Установка времени и даты");
    // private async Task SendSetMaxSpeedShuttleCommand() => await SendCommandAsync("dSp", "Установка максимальной скорости");
    // private async Task SendSetMinPowerShuttleCommand() => await SendCommandAsync("dBc", "Установка минимальной мощности");
    // private async Task SendMoveForwardShuttleCommand() => await SendCommandAsync("dMr", "Проезд расстояния вперёд");
    // private async Task SendSetMoveReverseShuttleCommand() => await SendCommandAsync("dMf", "Проезд расстояния назад");
    // private async Task SendSetShuttleNumCommand() => await SendCommandAsync("dNN", "Установка номера шаттла");
    private async Task SendUseReverseModeShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dRevOn", "Реверс режим");
    private async Task SendSealingForwardShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dComFo", "Уплотнение вперед");
    private async Task SendSealingBackShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dComBa", "Уплотнение назад");

    private async Task SendUpShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dUp___", "Подъём");
    private async Task SendLeftShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dLeft_", "движение назад");
    private async Task SendRightShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dRight", "движение вперёд");
    private async Task SendDownShuttleCommand() => await SendCommandAsync($"{Shuttle.ShuttleNumber}dDown_", "Спуск");

    private async Task SendFRMFirmwareCommand() => await SendUpdateCommandAndOpenBrowser();
    private async Task SendUpdateStateShuttleCommand() => await SendUPDCommandAndOpenBrowser();

    private async Task SendRebootShuttleCommand() => await SendCommandAsync("RBT", "Reboot shuttle");

    private async Task SendUpdateCommandAndOpenBrowser()
    {
        await SendCommandAsync("FRM", "Прошивка");
        await OpenWebInterfaceAsync("FRM");
    }

    private async Task SendUPDCommandAndOpenBrowser()
    {
        await SendCommandAsync("UPD", "Обновление");
        await OpenWebInterfaceAsync("UPD");
    }

    private async Task OpenWebInterfaceAsync(string argOpenBrowser)
    {
        var url = $"http://{Shuttle.IPAddress}/";
        if (argOpenBrowser == "UPD")
        {
            url += "update";
        }       
        try
        {
            var uri = new Uri(url);
            await BrowserLauncher.OpenBrowserAsync(uri);
            LogToTerminal($"[INFO] Открыт веб-интерфейс: {url}\n");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка открытия веб-интерфейса {Url}", url);
            LogToTerminal($"[ERROR] Не удалось открыть браузер: {ex.Message}\n");
        }
    }

    private async Task SendManualCommand()
    {
        if (!string.IsNullOrWhiteSpace(_manualCommand))
        {
            await SendCommandAsync(_manualCommand.Trim(), "Ручная команда");
            _manualCommand = "";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendManualCommand();
        }
    }

    private async Task DisconnectThis()
    {
        HubClientService.DisconnectFromShuttle(Shuttle.IPAddress);
        LogToTerminal("[INFO] Запрошено отключение\n");
        await OnDisconnected.InvokeAsync(Shuttle.IPAddress);
    }

    private void ClearTerminal()
    {
        Shuttle.ClearTerminalMessage();
        // _terminalLines.Clear();
        _terminalOutputHtml = "";
        StateHasChanged();
    }

    private void LogToTerminal(string message)
    {
        var lines = message.Split(new[] { "\r\n", "\n", "\r" }, StringSplitOptions.RemoveEmptyEntries);

        Shuttle.AddTerminalMessage(message);
        //_terminalLines.AddRange(lines);

        if (Shuttle.GetTerminalMessages().Count > 1000)
        {
            Shuttle.RemoveTerminalMessage();
        }

        // if (_terminalLines.Count > 1000)
        // {
        //     _terminalLines.RemoveRange(0, _terminalLines.Count - 500);
        // }

        _terminalOutputHtml = string.Join("",
            Shuttle.GetTerminalMessages().Select(line =>
                $"<div class=\"terminal-line\">{System.Net.WebUtility.HtmlEncode(line)}</div>"));

        // _terminalOutputHtml = string.Join("",
        //     _terminalLines.Select(line =>
        //         $"<div class=\"terminal-line\">{System.Net.WebUtility.HtmlEncode(line)}</div>"));

        StateHasChanged();
        _ = ScrollTerminalToBottomAsync();
    }

    private async Task ScrollTerminalToBottomAsync()
    {
        try
        {
            var elementId = $"terminalContainer_{_componentId}";
            await JSRuntime.InvokeVoidAsync("scrollToBottomIfNeeded", elementId);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Ошибка скролла терминала");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ScrollTerminalToBottomAsync();
        }
    }

    private string GetBatteryColorClass() => BatteryPercentageValue switch
    {
        >= 70 => "text-success",
        >= 30 => "text-warning",
        _ => "text-danger"
    };

    private string GetBatteryProgressClass() => BatteryPercentageValue switch
    {
        >= 70 => "bg-success",
        >= 30 => "bg-warning",
        _ => "bg-danger"
    };

    private string GetStatusColorClass() => CurrentStatus.ToLowerInvariant() switch
    {
        string s when s.Contains("ошибка") || s.Contains("error") => "text-danger",
        string s when s.Contains("предупреждение") || s.Contains("warning") => "text-warning",
        string s when s.Contains("работа") || s.Contains("work") => "text-success",
        _ => "text-secondary"
    };


    public void Dispose()
    {
        Logger.LogInformation("Дисконнект компонента для IP: {IpAddress}", Shuttle.IPAddress);

        _componentCts.Cancel();
        _componentCts.Dispose();

        HubClientService.Connected -= OnHubConnected;
        HubClientService.Disconnected -= OnHubDisconnected;
        HubClientService.TelemetryReceived -= OnTelemetryReceived;
        HubClientService.LogReceived -= OnLogReceived;
    }
}